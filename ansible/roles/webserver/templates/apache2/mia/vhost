ServerAdmin {{webserver_admin_email}}

DocumentRoot /opt/concurrent-thinking/ct-visualisation-app/core/public

AddType application/vnd.ms-fontobject .eot
# AddType application/x-woff .woff
AddType font/opentype .woff
AddType font/ttf .ttf
AddType font/opentype .otf

<Directory "/opt/concurrent-thinking/ct-visualisation-app/core/public">
  SetEnv APACHE_ERROR_LOG /var/log/apache2/web_ssl_error.log
  Options FollowSymLinks
  AllowOverride None
  Require all granted
</Directory>

<Location "/">
RedirectMatch ^/$ https://{{webserver_host_and_domain}}/--/
</Location>

RewriteEngine On

<Location "/errors">
  Options +Includes
</Location>


# Rewrite anything with the /mrd/ prefix to the metric reporting daemon.
RewriteRule ^/mrd/(.*)$ http://localhost:3000/$1 [P]

# static files always read from apache
# XXX We want apache serving static files in production, but not in development.  How to do that.
# RewriteRule ^/(.*\.(html|js|css))$ /$1 [PT]
# RewriteRule ^/(.*\.(eot|ttf|woff|svg|png))$ /$1 [PT]
RewriteRule ^/(.*\.var)$ /$1 [PT]

# /sys URIs are served by PHP scripts living in the document root.
RewriteRule ^/sys/date$ /sys/date_responder.php [PT]

# Uncomment for rewrite debugging
#RewriteLog /var/log/apache2/mia_rewrite.log
#RewriteLogLevel 9 

# We don't have support for this yet, but we will likely want it before too
# long.
# Check for maintenance file and redirect all requests
# RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
# RewriteCond %{SCRIPT_FILENAME} !maintenance.html
# RewriteRule ^.*$ /system/maintenance.html [L]

# Rewrite index to check for static
# XXX Do we still want this?
RewriteRule ^/$ /index.html [QSA] 

# Rewrite anything with the /--/ prefix to ct-visualisation-app
# XXX Remove the `/--/` prefix.
RewriteRule ^/(--/.*)$ http://localhost:7000/$1 [P,QSA,L]

# Rewrite to check for Rails cached page
RewriteRule ^([^.]+)$ $1.html [QSA]

# Redirect all non-static requests to cluster
# XXX Pretty sure that this can go.  Let's see.
# RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f

# Deflate
AddOutputFilterByType DEFLATE text/html text/plain text/xml application/xml application/xhtml+xml text/javascript text/css
BrowserMatch ^Mozilla/4 gzip-only-text/html
BrowserMatch ^Mozilla/4.0[678] no-gzip
BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

# Uncomment for deflate debugging
#DeflateFilterNote Input input_info
#DeflateFilterNote Output output_info
#DeflateFilterNote Ratio ratio_info
#LogFormat '"%r" %{output_info}n/%{input_info}n (%{ratio_info}n%%)' deflate
#CustomLog /var/log/apache2/mia_deflate.log deflate

ErrorDocument 500 /errors/500.html
ErrorDocument 503 /errors/503.html

<IfModule mod_include.c>
AddType text/html .shtml
AddHandler INCLUDES .shtml
ErrorDocument 500 /errors/500.shtml
ErrorDocument 503 /errors/503.shtml
</IfModule>

ExpiresActive On
ExpiresDefault A0
FileETag All

<FilesMatch "\.(html|js|css|png|gif|swf|ttf|svg|otf|woff|eot)$">
  ExpiresDefault A900
  Header set Cache-Control "public, max-age=900"
</FilesMatch>
