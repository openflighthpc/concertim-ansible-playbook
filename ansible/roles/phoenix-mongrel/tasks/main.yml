- name: Install mongrel gems
  ansible.builtin.command:
    cmd: gem1.8 install --no-rdoc --no-ri "{{item}}"
  loop:
    - gem_plugin
    - daemons
    - fastthread
    - cgi_multipart_eof_fix
    - mongrel
    - mongrel_cluster

- name: Install systemd files
  include_tasks: install_systemd_files.yml
  vars:
    systemd_service_name: phoenix-mongrel
    systemd_instance_names: "{{ mongrel_servername_ports  | join(' ') }}"

- name: Make config directory
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    state: directory
  loop:
    - path: "{{ mongrel_conf_dir }}"
      owner: root
      group: root
      mode: u=rwx,g=rx,o=rx

- name: Link binaries
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
  loop:
    - src: "{{ gem_18_bin_dir }}/mongrel_cluster_ctl"
      dest: /usr/sbin/mongrel_cluster_ctl
    - src: "{{ gem_18_bin_dir }}/mongrel_rails"
      dest: /usr/sbin/mongrel_rails

- name: Clear romance log for monit reasons
  block:
    - name: Install mongrel rails clear
      ansible.builtin.copy:
        src: mongrel_rails_clear
        dest: /usr/sbin
        owner: root
        group: root
        mode: "755"

    - name: mongrel_rails clears logs
      ansible.builtin.lineinfile:
        path: /usr/sbin/mongrel_rails
        insertafter: 'require.*rubygems'
        firstmatch: yes
        line: 'system("/usr/sbin/mongrel_rails_clear #{ARGV.join(" ")}")'

- name: Ensure that mongrel_cluster is enabled
  ansible.builtin.service:
    name: phoenix-mongrel
    enabled: yes
